          0 :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
          0 :                            cpu     1804A
          0 :                            option  "smart-branch", "on"
          0 :                            include "cdp1802.inc"
(1)       0 :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
(1)       0 :
(1)       0 :                    ;;; CDP1802 register alias
(1)       0 : =0                 R0:     equ     0
(1)       0 : =1                 R1:     equ     1
(1)       0 : =2                 R2:     equ     2
(1)       0 : =3                 R3:     equ     3
(1)       0 : =4                 R4:     equ     4
(1)       0 : =5                 R5:     equ     5
(1)       0 : =6                 R6:     equ     6
(1)       0 : =7                 R7:     equ     7
(1)       0 : =8                 R8:     equ     8
(1)       0 : =9                 R9:     equ     9
(1)       0 : =A                 R10:    equ     10
(1)       0 : =B                 R11:    equ     11
(1)       0 : =C                 R12:    equ     12
(1)       0 : =D                 R13:    equ     13
(1)       0 : =E                 R14:    equ     14
(1)       0 : =F                 R15:    equ     15
(1)       0 :
(1)       0 :                    ;;; Transfer locations
(1)       0 : =0                 ORG_RESET:      equ     0000H   ; Reset transfer location
          0 :
          0 :                            org     ORG_RESET
          0 : 71                         dis                     ; disable interrupt
          1 : 00                         dc      X'00'           ; X:P=0:0
          2 : 30 04                      br      scrt_init
          4 :                            include "scrt.inc"
(1)       4 :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
(1)       4 :
(1)       4 :                    ;;; Standard Call and Return Technique
(1)       4 :                    ;;; R0: DMA pointer
(1)       4 :                    ;;; R1: Program counter for Interrupt routine
(1)       4 :                    ;;; R2: Stack pointer
(1)       4 :                    ;;; R3: Program counter
(1)       4 :                    ;;; R4: Link register, pointer to the return location and arguments
(1)       4 :                    ;;;     passed by the calling program
(1)       4 :
(1)       4 :                    ;;; Call subroutine
(1)       4 :                    ;;;   SCAL R4, subroutine
(1)       4 :                    ;;;   DC   arguments...
(1)       4 :                    ;;; Subroutine return
(1)       4 :                    ;;;   SRET R4
(1)       4 :                    ;;; Return from interrupt
(1)       4 :                    ;;;   SEP R1
(1)       4 :
(1)       4 :                    ;;; Initialize for SCRT, P=0
(1)       4 :                    ;;; @param P!=3
(1)       4 :                    ;;; @param stack top address of stack
(1)       4 :                    ;;; @param main start address of main routine
(1)       4 :                    ;;; @return P=3
(1)       4 :                    ;;; @return R1=scrt_isr
(1)       4 :                    ;;; @return R2=stack
(1)       4 :                    ;;; @return R3=main
(1)       4 :                    ;;; @clobber D, R15
(1)       4 :                    scrt_init:
(1)       4 : 68 C3 00 09                rldi    R3, scrt_start
(1)       8 : D3                         sep     R3              ; P=3
(1)       9 :                    scrt_start:
(1)       9 : 68 C1 00 1E                rldi    R1, scrt_isr    ; setup interrupt
(1)       D : E2                         sex     R2
(1)       E : 68 C2 0F FF                rldi    R2, stack       ; setup stack
(1)      12 : C0 10 00                   br      main            ; goto main with P=3
(1)      15 :
(1)      15 :                    ;;; Interrupt exit entry P=1
(1)      15 :                    ;;;  (Come here by SEP R1)
(1)      15 :                    scrt_isr_exit:
(1)      15 : 60                         irx
(1)      16 : 68 63                      rlxa    R3              ; pop program counter R3
(1)      18 : 68 6F                      rlxa    R15             ; pop scratch pad register R15
(1)      1A : 72                         ldxa                    ; pop DF into D:MSB
(1)      1B : FE                         shl                     ; restore DF
(1)      1C : 72                         ldxa                    ; pop D
(1)      1D : 70                         ret                     ; restore X,P IE=1
(1)      1E :                            ;; R1 points scrt_isr
(1)      1E :                    ;;; CDP1802 interrupt entry, X=2, P=1, IE=0
(1)      1E :                    ;;; @unchanged D, DF, X, P, R3, R15
(1)      1E :                    scrt_isr:
(1)      1E :                            ;; R2[0] must be preserved because it may be in the pop process
(1)      1E : 22                         dec     R2
(1)      1F : 78                         sav                     ; push X,P
(1)      20 : 22                         dec     R2
(1)      21 : 73                         stxd                    ; push D
(1)      22 : 76                         shrc                    ; MSB of D=DF
(1)      23 : 73                         stxd                    ; push DF
(1)      24 : 68 AF                      rsxd    R15             ; push scratch pad register R15
(1)      26 : 68 A3                      rsxd    R3              ; push program counter R3
(1)      28 : 68 C3 10 0E                rldi    R3, isr
(1)      2C : D3                         sep     R3              ; call interrupt service routine with P=3
(1)      2D : 30 15                      br      scrt_isr_exit   ; return from isr by SEP R1
         2F :
         2F :                    ;;; MC6850 Asynchronous Communication Interface Adapter
         2F : =DF00              ACIA:   equ     X'DF00'
         2F :                            include "mc6850.inc"
(1)      2F :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
(1)      2F :
(1)      2F :                    ;;; MC6850
(1)      2F :                    ;;; Asynchronous Communication Interface Adapter
(1)      2F :
(1)      2F :                    ;;; Control register
(1)      2F : =DF00              ACIA_control:   equ     ACIA+0
(1)      2F :                            ;; Counter Divider Select Bits
(1)      2F : =3                 CDS_gm:         equ     11b    ; Group mask
(1)      2F : =0                 CDS_DIV1_gc:    equ     00000000B ; /1
(1)      2F : =1                 CDS_DIV16_gc:   equ     00000001B ; /16
(1)      2F : =2                 CDS_DIV64_gc:   equ     00000010B ; /64
(1)      2F : =3                 CDS_RESET_gc:   equ     00000011B ; Master Reset
(1)      2F :                            ;; Word Select Bits
(1)      2F : =1C                WSB_gm:         equ     00011100B ; Group mask
(1)      2F : =0                 WSB_7E2_gc:     equ     00000000B ; 7 Bits + Even Parity + 2 Stop Bits
(1)      2F : =4                 WSB_7O2_gc:     equ     00000100B ; 7 bits + Odd Parity  + 2 Stop Bits
(1)      2F : =8                 WSB_7E1_gc:     equ     00001000B ; 7 bits + Even Parity + 1 Stop Bits
(1)      2F : =C                 WSB_7O1_gc:     equ     00001100B ; 7 bits + Odd Parity  + 1 Stop Bits
(1)      2F : =10                WSB_8N2_gc:     equ     00010000B ; 8 bits + No Parity   + 2 Stop Bits
(1)      2F : =14                WSB_8N1_gc:     equ     00010100B ; 8 bits + No Parity   + 1 Stop Bits
(1)      2F : =18                WSB_8E1_gc:     equ     00011000B ; 8 bits + Even Parity + 1 Stop Bits
(1)      2F : =1C                WSB_8O1_gc:     equ     00011100B ; 8 bits + Odd Parity  + 1 Stop Bits
(1)      2F :                            ;; Transmit Control Bits
(1)      2F : =60                TCB_gm:         equ     01100000B ; Group mask
(1)      2F : =0                 TCB_DI_gc:      equ     00000000B ; RTS=Low,  Tx Interrupt Disabled
(1)      2F : =20                TCB_EI_gc:      equ     00100000B ; RTS=Low,  Tx Interrupt Enabled
(1)      2F : =40                TCB_RTS_gc:     equ     01000000B ; RTS=High, Tx Interrupt Disabled
(1)      2F : =60                TCB_BREAK_gc:   equ     01100000B ; RTS=Low,  Tx Interrupt Disabled
(1)      2F :                                                      ; Transmit Break Level
(1)      2F : =80                RIEB_bm:        equ     10000000B ; Receive Interrupt Enable Bit mask
(1)      2F :
(1)      2F :                    ;;; Status register
(1)      2F : =DF00              ACIA_status:    equ     ACIA+0
(1)      2F : =1                 RDRF_bm:        equ     00000001B ; Receive Data Register Full
(1)      2F : =2                 TDRE_bm:        equ     00000010B ; Transmit Data Register Empty
(1)      2F : =4                 DCDF_bm:        equ     00000100B ; Data Carrier Detect Flag
(1)      2F : =8                 CTSF_bm:        equ     00001000B ; Clear To Send Flag
(1)      2F : =10                FERR_bm:        equ     00010000B ; Frame Error Flag
(1)      2F : =20                OVRN_bm:        equ     00100000B ; Receiver Overrun Flag
(1)      2F : =40                PERR_bm:        equ     01000000B ; Parity Error Flag
(1)      2F : =80                IRQF_bm:        equ     10000000B ; Interrupt Request Flag
(1)      2F :
(1)      2F :                    ;;; Data register
(1)      2F : =DF01              ACIA_data:      equ     ACIA+1          ; Data register
         2F :
       1000 :                            org     X'1000'
       1000 : =FFF               stack:  equ     *-1
       1000 :                    main:
       1000 : 68 C8 DF 00                rldi    R8, ACIA
       1004 : F8 03                      ldi     CDS_RESET_gc    ; Master reset
       1006 : 58                         str     R8              ; ACIA_control
       1007 : F8 14                      ldi     WSB_8N1_gc      ; 8 bits + No Parity + 1 Stop Bits
       1009 :                                                    ; Transmit, Receive interrupts disabled
       1009 : 58                         str     R8              ; ACIA_control
       100A :
       100A : 68 84 10 91                scal    R4, arith       ; call arith
       100E :                    isr:
       100E : 00                         idl
       100F :
       100F :                    ;;; Print out char
       100F :                    ;;; @param D char
       100F :                    ;;; @clobber R15.0
       100F :                    putchar:
       100F : AF                         plo     R15             ; save D to R15.0
       1010 : 68 A8                      rsxd    R8              ; save R8
       1012 : 68 C8 DF 00                rldi    R8, ACIA
       1016 :                    putchar_loop:
       1016 : 08                         ldn     R8              ; ACIA_status
       1017 : FA 02                      ani     TDRE_bm
       1019 : 32 16                      bz      putchar_loop
       101B : 8F                         glo     R15             ; restore D
       101C : 18                         inc     R8
       101D : 58                         str     R8              ; ACIA_data
       101E : 60                         irx
       101F : 68 68                      rlxa    R8
       1021 : 22                         dec     R2
       1022 : 68 94                      sret    R4
       1024 :
       1024 :                    ;;; Print out newline
       1024 :                    ;;; @clobber D R15.0
       1024 :                    newline:
       1024 : F8 0D                      ldi     X'0D'
       1026 : 68 84 10 0F                scal    R4, putchar
       102A : F8 0A                      ldi     X'0A'
       102C : 30 0F                      br      putchar
       102E :
       102E :                    ;;; Print out space
       102E :                    ;;; @clobber D R15.0
       102E :                    putspace:
       102E : F8 20                      ldi     T' '
       1030 : 30 0F                      br      putchar
       1032 :
       1032 :                    ;;; Print out expression "operand1 operator operand2"
       1032 :                    ;;; @param R7 operand1
       1032 :                    ;;; @param R8 operand2
       1032 :                    ;;; @param D operator
       1032 :                    ;;; @clobber D R15
       1032 :                    expr:
       1032 : 68 A7                      rsxd    R7              ; save R7
       1034 : 73                         stxd                    ; save operator
       1035 : 68 84 12 E2                scal    R4, print_int16 ; print R7
       1039 : 68 84 10 2E                scal    R4, putspace
       103D : 12                         inc     R2
       103E : 02                         ldn     R2              ; restore operator
       103F : 68 84 10 0F                scal    R4, putchar     ; print operator
       1043 : 68 84 10 2E                scal    R4, putspace
       1047 : 98                         ghi     R8
       1048 : B7                         phi     R7
       1049 : 88                         glo     R8
       104A : A7                         plo     R7
       104B : 68 84 12 E2                scal    R4, print_int16 ; print R8
       104F : 60                         irx
       1050 : 68 67                      rlxa    R7              ; restore R7
       1052 : 22                         dec     R2
       1053 : 68 94                      sret    R4
       1055 :
       1055 :                    ;;; Print out answer " = result\n"
       1055 :                    ;;; @params R7 result
       1055 :                    ;;; @clobber D R7 R15
       1055 :                    answer:
       1055 : 68 84 10 2E                scal    R4, putspace
       1059 : F8 3D                      ldi     T'='
       105B : 68 84 10 0F                scal    R4, putchar
       105F : 68 84 10 2E                scal    R4, putspace
       1063 : 68 84 12 E2                scal    R4, print_int16
       1067 : 30 24                      br      newline
       1069 :
       1069 :                    ;;; Compare 2 integers and print out "operand1 <=> operand2\n"
       1069 :                    ;;; @param R7 operand1
       1069 :                    ;;; @param R8 operand2
       1069 :                    ;;; @clobber R15
       1069 :                    comp:
       1069 : 68 A7                      rsxd    R7              ; save R7
       106B : 68 A8                      rsxd    R8              ; save R8
       106D : 68 84 13 53                scal    R4, cmp16
       1071 : 3B 83                      bl      comp_lt
       1073 : 32 7F                      bz      comp_eq
       1075 : 33 7B                      bge     comp_gt
       1077 : F8 3F                      ldi     T'?'
       1079 : 30 85                      br      comp_out
       107B :                    comp_gt:
       107B : F8 3E                      ldi     T'>'
       107D : 30 85                      br      comp_out
       107F :                    comp_eq:
       107F : F8 3D                      ldi     T'='
       1081 : 30 85                      br      comp_out
       1083 :                    comp_lt:
       1083 : F8 3C                      ldi     T'<'
       1085 :                    comp_out:
       1085 : 60                         irx
       1086 : 68 68                      rlxa    R8              ; restore R8
       1088 : 68 67                      rlxa    R7              ; restore R7
       108A : 22                         dec     R2
       108B : 68 84 10 32                scal    R4, expr
       108F : 30 24                      br      newline
       1091 :
       1091 :                    arith:
       1091 : 68 C7 00 00                rldi    R7, 0
       1095 : 68 C8 92 A0                rldi    R8, -28000
       1099 : F8 2D                      ldi     T'-'
       109B : 68 84 10 32                scal    R4, expr
       109F : 68 84 13 47                scal    R4, sub16
       10A3 : 68 84 10 55                scal    R4, answer      ; 28000
       10A7 :
       10A7 : 68 C7 00 00                rldi    R7, 0
       10AB : 68 C8 6D 60                rldi    R8, 28000
       10AF : F8 2D                      ldi     T'-'
       10B1 : 68 84 10 32                scal    R4, expr
       10B5 : 68 84 13 47                scal    R4, sub16
       10B9 : 68 84 10 55                scal    R4, answer      ; -28000
       10BD :
       10BD : 68 C7 46 50                rldi    R7, 18000
       10C1 : 68 C8 6D 60                rldi    R8, 28000
       10C5 : F8 2B                      ldi     T'+'
       10C7 : 68 84 10 32                scal    R4, expr
       10CB : 68 84 13 3B                scal    R4, add16
       10CF : 68 84 10 55                scal    R4, answer      ; -19536
       10D3 :
       10D3 : 68 C7 46 50                rldi    R7, 18000
       10D7 : 68 C8 B9 B0                rldi    R8, -18000
       10DB : F8 2B                      ldi     T'+'
       10DD : 68 84 10 32                scal    R4, expr
       10E1 : 68 84 13 3B                scal    R4, add16
       10E5 : 68 84 10 55                scal    R4, answer      ; 0
       10E9 :
       10E9 : 68 C7 B9 B0                rldi    R7, -18000
       10ED : 68 C8 B9 B0                rldi    R8, -18000
       10F1 : F8 2B                      ldi     T'+'
       10F3 : 68 84 10 32                scal    R4, expr
       10F7 : 68 84 13 3B                scal    R4, add16
       10FB : 68 84 10 55                scal    R4, answer      ; 29536
       10FF :
       10FF : 68 C7 46 50                rldi    R7, 18000
       1103 : 68 C8 92 A0                rldi    R8, -28000
       1107 : F8 2D                      ldi     T'-'
       1109 : 68 84 10 32                scal    R4, expr
       110D : 68 84 13 47                scal    R4, sub16
       1111 : 68 84 10 55                scal    R4, answer      ; -19536
       1115 :
       1115 : 68 C7 46 50                rldi    R7, 18000
       1119 : 68 C8 B9 B0                rldi    R8, -18000
       111D : F8 2D                      ldi     T'-'
       111F : 68 84 10 32                scal    R4, expr
       1123 : 68 84 13 47                scal    R4, sub16
       1127 : 68 84 10 55                scal    R4, answer      ; 29536
       112B :
       112B : 68 C7 92 A0                rldi    R7, -28000
       112F : 68 C8 B9 B0                rldi    R8, -18000
       1133 : F8 2D                      ldi     T'-'
       1135 : 68 84 10 32                scal    R4, expr
       1139 : 68 84 13 47                scal    R4, sub16
       113D : 68 84 10 55                scal    R4, answer      ; -10000
       1141 :
       1141 : 68 C7 00 64                rldi    R7, 100
       1145 : 68 C8 01 2C                rldi    R8, 300
       1149 : F8 2A                      ldi     T'*'
       114B : 68 84 10 32                scal    R4, expr
       114F : 68 84 13 A8                scal    R4, mul16
       1153 : 68 84 10 55                scal    R4, answer      ; 30000
       1157 :
       1157 : 68 C7 00 C8                rldi    R7, 200
       115B : 68 C8 FF 9C                rldi    R8, -100
       115F : F8 2A                      ldi     T'*'
       1161 : 68 84 10 32                scal    R4, expr
       1165 : 68 84 13 A8                scal    R4, mul16
       1169 : 68 84 10 55                scal    R4, answer      ; -20000
       116D :
       116D : 68 C7 01 2C                rldi    R7, 300
       1171 : 68 C8 FF 38                rldi    R8, -200
       1175 : F8 2A                      ldi     T'*'
       1177 : 68 84 10 32                scal    R4, expr
       117B : 68 84 13 A8                scal    R4, mul16
       117F : 68 84 10 55                scal    R4, answer      ; 5536
       1183 :
       1183 : 68 C7 FF 9C                rldi    R7, -100
       1187 : 68 C8 01 2C                rldi    R8, 300
       118B : F8 2A                      ldi     T'*'
       118D : 68 84 10 32                scal    R4, expr
       1191 : 68 84 13 A8                scal    R4, mul16
       1195 : 68 84 10 55                scal    R4, answer      ; -30000
       1199 :
       1199 : 68 C7 FF 38                rldi    R7, -200
       119D : 68 C8 FF 9C                rldi    R8, -100
       11A1 : F8 2A                      ldi     T'*'
       11A3 : 68 84 10 32                scal    R4, expr
       11A7 : 68 84 13 A8                scal    R4, mul16
       11AB : 68 84 10 55                scal    R4, answer      ; 20000
       11AF :
       11AF : 68 C7 75 30                rldi    R7, 30000
       11B3 : 68 C8 00 64                rldi    R8, 100
       11B7 : F8 2F                      ldi     T'/'
       11B9 : 68 84 10 32                scal    R4, expr
       11BD : 68 84 14 36                scal    R4, div16
       11C1 : 68 84 10 55                scal    R4, answer      ; 30
       11C5 :
       11C5 : 68 C7 FF 38                rldi    R7, -200
       11C9 : 68 C8 00 64                rldi    R8, 100
       11CD : F8 2F                      ldi     T'/'
       11CF : 68 84 10 32                scal    R4, expr
       11D3 : 68 84 14 36                scal    R4, div16
       11D7 : 68 84 10 55                scal    R4, answer      ; -2
       11DB :
       11DB : 68 C7 8A D0                rldi    R7, -30000
       11DF : 68 C8 FF 38                rldi    R8, -200
       11E3 : F8 2F                      ldi     T'/'
       11E5 : 68 84 10 32                scal    R4, expr
       11E9 : 68 84 14 36                scal    R4, div16
       11ED : 68 84 10 55                scal    R4, answer      ; 150
       11F1 :
       11F1 : 68 C7 8A D0                rldi    R7, -30000
       11F5 : 68 C8 00 4E                rldi    R8, 78
       11F9 : F8 2F                      ldi     T'/'
       11FB : 68 84 10 32                scal    R4, expr
       11FF : 68 84 14 36                scal    R4, div16
       1203 : 68 84 10 55                scal    R4, answer      ; -384
       1207 :
       1207 : 68 C7 13 88                rldi    R7, 5000
       120B : 68 C8 0F A0                rldi    R8, 4000
       120F : 68 84 10 69                scal    R4, comp
       1213 :
       1213 : 68 C7 13 88                rldi    R7, 5000
       1217 : 68 C8 13 88                rldi    R8, 5000
       121B : 68 84 10 69                scal    R4, comp
       121F :
       121F : 68 C7 0F A0                rldi    R7, 4000
       1223 : 68 C8 13 88                rldi    R8, 5000
       1227 : 68 84 10 69                scal    R4, comp
       122B :
       122B : 68 C7 EC 78                rldi    R7, -5000
       122F : 68 C8 F0 60                rldi    R8, -4000
       1233 : 68 84 10 69                scal    R4, comp
       1237 :
       1237 : 68 C7 EC 78                rldi    R7, -5000
       123B : 68 C8 EC 78                rldi    R8, -5000
       123F : 68 84 10 69                scal    R4, comp
       1243 :
       1243 : 68 C7 F0 60                rldi    R7, -4000
       1247 : 68 C8 EC 78                rldi    R8, -5000
       124B : 68 84 10 69                scal    R4, comp
       124F :
       124F : 68 C7 7F BC                rldi    R7, 32700
       1253 : 68 C8 7F 58                rldi    R8, 32600
       1257 : 68 84 10 69                scal    R4, comp
       125B :
       125B : 68 C7 7F BC                rldi    R7, 32700
       125F : 68 C8 7F BC                rldi    R8, 32700
       1263 : 68 84 10 69                scal    R4, comp
       1267 :
       1267 : 68 C7 7F 58                rldi    R7, 32600
       126B : 68 C8 7F BC                rldi    R8, 32700
       126F : 68 84 10 69                scal    R4, comp
       1273 :
       1273 : 68 C7 80 44                rldi    R7, -32700
       1277 : 68 C8 80 A8                rldi    R8, -32600
       127B : 68 84 10 69                scal    R4, comp
       127F :
       127F : 68 C7 80 44                rldi    R7, -32700
       1283 : 68 C8 80 44                rldi    R8, -32700
       1287 : 68 84 10 69                scal    R4, comp
       128B :
       128B : 68 C7 80 A8                rldi    R7, -32600
       128F : 68 C8 80 44                rldi    R8, -32700
       1293 : 68 84 10 69                scal    R4, comp
       1297 :
       1297 : 68 C7 46 50                rldi    R7, 18000
       129B : 68 C8 92 A0                rldi    R8, -28000
       129F : 68 84 10 69                scal    R4, comp
       12A3 :
       12A3 : 68 C7 92 A0                rldi    R7, -28000
       12A7 : 68 C8 92 A0                rldi    R8, -28000
       12AB : 68 84 10 69                scal    R4, comp
       12AF :
       12AF : 68 C7 92 A0                rldi    R7, -28000
       12B3 : 68 C8 46 50                rldi    R8, 18000
       12B7 : 68 84 10 69                scal    R4, comp
       12BB :
       12BB : 68 94                      sret    R4
       12BD :
       12BD :                            include "arith.inc"
(1)    12BD :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
(1)    12BD :                            cpu     1804A
(1)    12BD :
(1)    12BD :                    ;;; Print unsigned 16-bit integer as decimal
(1)    12BD :                    ;;; @param R7 value
(1)    12BD :                    ;;; @clobber D R7 R8 R15
(1)    12BD :                    print_uint16:
(1)    12BD : 97                         ghi     R7
(1)    12BE : 3A C3                      bnz     print_uint16_loop
(1)    12C0 : 87                         glo     R7
(1)    12C1 : 32 DD                      bz      print_uint16_zero
(1)    12C3 :                    print_uint16_loop:
(1)    12C3 : 97                         ghi     R7
(1)    12C4 : 3A CB                      bnz     print_uint16_digit
(1)    12C6 : 87                         glo     R7
(1)    12C7 : 3A CB                      bnz     print_uint16_digit
(1)    12C9 : 68 94                      sret    R4
(1)    12CB :                    print_uint16_digit:
(1)    12CB : F8 00                      ldi     0
(1)    12CD : B8                         phi     R8
(1)    12CE : F8 0A                      ldi     10
(1)    12D0 : A8                         plo     R8              ; divisor=10
(1)    12D1 : 68 84 13 DE                scal    R4, udiv16
(1)    12D5 : 88                         glo     R8
(1)    12D6 : 73                         stxd                    ; push reminder
(1)    12D7 : 68 84 12 C3                scal    R4, print_uint16_loop
(1)    12DB : 12                         inc     R2
(1)    12DC : 02                         ldn     R2              ; pop reminder
(1)    12DD :                    print_uint16_zero:
(1)    12DD : FC 30                      adi     T'0'
(1)    12DF : C0 10 0F                   br      putchar
(1)    12E2 :
(1)    12E2 :                    ;;; Print signed 16-bit integer as decimal
(1)    12E2 :                    ;;; @param R7 value
(1)    12E2 :                    ;;; @clobber D R15
(1)    12E2 :                    print_int16:
(1)    12E2 : 68 A8                      rsxd    R8              ; save R8
(1)    12E4 : 68 A7                      rsxd    R7              ; save R7
(1)    12E6 : 97                         ghi     R7
(1)    12E7 : FA 80                      ani     X'80'
(1)    12E9 : 32 FA                      bz      print_int16_print
(1)    12EB : F8 2D                      ldi     T'-'
(1)    12ED : 68 84 10 0F                scal    R4, putchar      ; print '-'
(1)    12F1 : 97                         ghi     R7
(1)    12F2 : FB FF                      xri     X'FF'
(1)    12F4 : B7                         phi     R7
(1)    12F5 : 87                         glo     R7
(1)    12F6 : FB FF                      xri     X'FF'
(1)    12F8 : A7                         plo     R7
(1)    12F9 : 17                         inc     R7              ; negate value
(1)    12FA :                    print_int16_print:
(1)    12FA : 68 84 12 BD                scal    R4, print_uint16
(1)    12FE : 60                         irx
(1)    12FF : 68 67                      rlxa    R7              ; restore R7
(1)    1301 : 68 68                      rlxa    R8              ; restore R8
(1)    1303 : 22                         dec     R2
(1)    1304 : 68 94                      sret    R4
(1)    1306 :
(1)    1306 :                    ;;; Store R7 to variable
(1)    1306 :                    ;;;   SCAL R4, store_R7
(1)    1306 :                    ;;;   DC   A(variable)
(1)    1306 :                    ;;; @clobber D
(1)    1306 :                    store_R7:
(1)    1306 : 68 A8                      rsxd    R8              ; save R8
(1)    1308 : E4                         sex     R4
(1)    1309 : 68 68                      rlxa    R8              ; R8=&valiable
(1)    130B : E8                         sex     R8
(1)    130C : 60                         irx
(1)    130D : 68 A7                      rsxd    R7
(1)    130F : E2                         sex     R2
(1)    1310 : 60                         irx
(1)    1311 : 68 68                      rlxa    R8              ; restore R8
(1)    1313 : 22                         dec     R2
(1)    1314 : 68 94                      sret    R4
(1)    1316 :
(1)    1316 :                    ;;; Load variable to R7
(1)    1316 :                    ;;;   SCAL R4, load_R7
(1)    1316 :                    ;;;   DC   A(variable)
(1)    1316 :                    ;;; @return R7 variable
(1)    1316 :                    ;;; @clobber R15
(1)    1316 :                    load_R7:
(1)    1316 : E4                         sex     R4
(1)    1317 : 68 67                      rlxa    R7              ; R7=&variable
(1)    1319 : E7                         sex     R7
(1)    131A : 68 67                      rlxa    R7
(1)    131C : E2                         sex     R2
(1)    131D : 68 94                      sret    R4
(1)    131F :
(1)    131F :                    ;;; Load variable to R8
(1)    131F :                    ;;;   SCAL R4, load_R8
(1)    131F :                    ;;;   DC   A(variable)
(1)    131F :                    ;;; @clobber R15
(1)    131F :                    load_R8:
(1)    131F : E4                         sex     R4
(1)    1320 : 68 68                      rlxa    R8              ; R8=&variable
(1)    1322 : E8                         sex     R8
(1)    1323 : 68 68                      rlxa    R8
(1)    1325 : E2                         sex     R2
(1)    1326 : 68 94                      sret    R4
(1)    1328 :
(1)    1328 :                    ;;; Increment variable
(1)    1328 :                    ;;;   SCAL R4, inc16
(1)    1328 :                    ;;;   DC   A(variable)
(1)    1328 :                    ;;; @return R7 variable
(1)    1328 :                    inc16:
(1)    1328 : 68 A8                      rsxd    R8              ; save R8
(1)    132A : E4                         sex     R4
(1)    132B : 68 68                      rlxa    R8              ; R8=$variable
(1)    132D : E8                         sex     R8
(1)    132E : 68 67                      rlxa    R7              ; load R7
(1)    1330 : 17                         inc     R7
(1)    1331 : 28                         dec     R8
(1)    1332 : 68 A7                      rsxd    R7              ; save R7
(1)    1334 : E2                         sex     R2
(1)    1335 : 60                         irx
(1)    1336 : 68 68                      rlxa    R8              ; restore R8
(1)    1338 : 22                         dec     R2
(1)    1339 : 68 94                      sret    R4
(1)    133B :
(1)    133B :                    ;;; Signed addition: summand += addend
(1)    133B :                    ;;; @param R7 summand
(1)    133B :                    ;;; @param R8 addend
(1)    133B :                    ;;; @return R7 summand + addend
(1)    133B :                    ;;;   SCAL R4, add16
(1)    133B :                    ;;; @clobber D
(1)    133B :                    add16:
(1)    133B : 88                         glo     R8
(1)    133C : 52                         str     R2
(1)    133D : 87                         glo     R7
(1)    133E : F4                         add
(1)    133F : A7                         plo     R7
(1)    1340 : 98                         ghi     R8
(1)    1341 : 52                         str     R2
(1)    1342 : 97                         ghi     R7
(1)    1343 : 74                         adc
(1)    1344 : B7                         phi     R7
(1)    1345 : 68 94                      sret    R4
(1)    1347 :
(1)    1347 :                    ;;; Singed subtraction: minuend -= subtrahend
(1)    1347 :                    ;;;   SCAL R4, sub16
(1)    1347 :                    ;;; @param R7 minuend
(1)    1347 :                    ;;; @param R8 subtrahend
(1)    1347 :                    ;;; @return R7 minuend - subtrahend
(1)    1347 :                    ;;; @clobber D
(1)    1347 :                    sub16:
(1)    1347 : 88                         glo     R8
(1)    1348 : 52                         str     R2
(1)    1349 : 87                         glo     R7
(1)    134A : F7                         sm
(1)    134B : A7                         plo     R7
(1)    134C : 98                         ghi     R8
(1)    134D : 52                         str     R2
(1)    134E : 97                         ghi     R7
(1)    134F : 77                         smb
(1)    1350 : B7                         phi     R7
(1)    1351 : 68 94                      sret    R4
(1)    1353 :
(1)    1353 :                    ;;; Signed comparison: minuend - subtrahend
(1)    1353 :                    ;;; @param R7 minuend
(1)    1353 :                    ;;; @param R8 subtrahend
(1)    1353 :                    ;;; @return D=0 DF=1 (minuend==subtrahend); BZ
(1)    1353 :                    ;;;         D=1 DF=1 (minuend>subtrahend);  BGE
(1)    1353 :                    ;;;         D=1 DF=0 (minuend<subtrahend);  BL
(1)    1353 :                    ;;; @clobber R7 R8
(1)    1353 :                    ;;; result = minuend - subtrahend
(1)    1353 :                    ;;; Z=(result.1 | result.0) == 0
(1)    1353 :                    ;;; N=(result.1 & 0x80) != 0
(1)    1353 :                    ;;; V=((minuend.1 ^ subtrahend.1) & (result.1 ^ minuend.1) & 0x80) != 0
(1)    1353 :                    ;;; LT=N ^ V
(1)    1353 :                    cmp16:
(1)    1353 : 88                         glo     R8              ; D=subtrahend.0
(1)    1354 : 52                         str     R2              ; stack top=subtrahend.0
(1)    1355 : 87                         glo     R7              ; D=minuend.0
(1)    1356 : F7                         sm                      ; D=minuend.0=subtrahend.0
(1)    1357 : A7                         plo     R7              ; R7.0=result.0
(1)    1358 : 98                         ghi     R8              ; D=subtrahend.1
(1)    1359 : 52                         str     R2              ; stack top=subtrahend.1
(1)    135A : 97                         ghi     R7              ; D=minuend.1
(1)    135B : F3                         xor                     ; D=minuend.1^subtrahend.1
(1)    135C : A8                         plo     R8              ; R8.0=minuend.1^subtrahend.1
(1)    135D : 97                         ghi     R7              ; D=minuend.1
(1)    135E : 77                         smb                     ; D=minuend.1=subtrahend.1
(1)    135F : B8                         phi     R8              ; R8.1=result.1
(1)    1360 : 3A 6A                      bnz     cmp16_neq       ; branch if result.1!=0
(1)    1362 : 87                         glo     R7              ; D=result.0
(1)    1363 : 3A 6A                      bnz     cmp16_neq       ; branch if result.0!=-
(1)    1365 : F8 01                      ldi     1
(1)    1367 : F6                         shr
(1)    1368 : 68 94                      sret    R4
(1)    136A :                    cmp16_neq:
(1)    136A : 98                         ghi     R8              ; D=result.1
(1)    136B : 52                         str     R2
(1)    136C : 97                         ghi     R7              ; D=minuend.1
(1)    136D : F3                         xor                     ; D=result.1^minuend.1
(1)    136E : 52                         str     R2              ; stack top=result.1^minuend.1
(1)    136F : 88                         glo     R8              ; D=minuend.1^subtrahend.1
(1)    1370 : F2                         and                     ; D=(minuend.1^subtrahend.1)&(result.1^minuend.1)
(1)    1371 : 52                         str     R2              ; stack top=V
(1)    1372 : 98                         ghi     R8              ; D=result.1
(1)    1373 : F3                         xor                     ; D=N^V
(1)    1374 : FB 80                      xri     X'80'           ; D=~(N^V)
(1)    1376 : FE                         shl                     ; DF=~(N^V)
(1)    1377 : F8 01                      ldi     1
(1)    1379 : 68 94                      sret    R4
(1)    137B :
(1)    137B :                    ;;; Unsigned multiplication: result = multiplicand * multiplier
(1)    137B :                    ;;; @param R7 multiplicand
(1)    137B :                    ;;; @param R8 multiplier
(1)    137B :                    ;;; @return R7 result
(1)    137B :                    ;;; @clobber D R7 R8 R15
(1)    137B :                    umul16:
(1)    137B : F8 00                      ldi     0
(1)    137D : BF                         phi     R15
(1)    137E : AF                         plo     R15             ; R15=result
(1)    137F : 30 9C                      br      umul16_check
(1)    1381 :                    umul16_loop:
(1)    1381 : 88                         glo     R8
(1)    1382 : FA 01                      ani     1
(1)    1384 : 32 90                      bz      umul16_sr       ; lsb(multiplier)==0
(1)    1386 : 87                         glo     R7
(1)    1387 : 52                         str     R2              ; stack top=multiplicand.0
(1)    1388 : 8F                         glo     R15
(1)    1389 : F4                         add
(1)    138A : AF                         plo     R15
(1)    138B : 97                         ghi     R7
(1)    138C : 52                         str     R2              ; stack top=multiplicand.1
(1)    138D : 9F                         ghi     R15
(1)    138E : 74                         adc
(1)    138F : BF                         phi     R15             ; result += multiplicand
(1)    1390 :                    umul16_sr:
(1)    1390 : 98                         ghi     R8
(1)    1391 : F6                         shr
(1)    1392 : B8                         phi     R8
(1)    1393 : 88                         glo     R8
(1)    1394 : 76                         shrc
(1)    1395 : A8                         plo     R8              ; multiplier >>= 1
(1)    1396 : 87                         glo     R7
(1)    1397 : FE                         shl
(1)    1398 : A7                         plo     R7
(1)    1399 : 97                         ghi     R7
(1)    139A : 7E                         shlc
(1)    139B : B7                         phi     R7              ; multiplicand <<= 1
(1)    139C :                    umul16_check:
(1)    139C : 98                         ghi     R8
(1)    139D : 3A 81                      bnz     umul16_loop     ; while multiplier != 0
(1)    139F : 88                         glo     R8
(1)    13A0 : 3A 81                      bnz     umul16_loop     ; while multiplier != 0
(1)    13A2 : 9F                         ghi     R15
(1)    13A3 : B7                         phi     R7
(1)    13A4 : 8F                         glo     R15
(1)    13A5 : A7                         plo     R7              ; R7=result
(1)    13A6 : 68 94                      sret    R4
(1)    13A8 :
(1)    13A8 :                    ;;; Signed multiplication: multiplicand *= multiplier
(1)    13A8 :                    ;;; @param R7 multiplicand
(1)    13A8 :                    ;;; @param R8 multiplier
(1)    13A8 :                    ;;; @return R7 multiplicand * multiplier
(1)    13A8 :                    ;;;   SCAL R4, mul16
(1)    13A8 :                    ;;; @clobber R8 R15
(1)    13A8 :                    mul16:
(1)    13A8 : 98                         ghi     R8
(1)    13A9 : 52                         str     R2
(1)    13AA : 97                         ghi     R7
(1)    13AB : F3                         xor
(1)    13AC : 73                         stxd                    ; push sign
(1)    13AD : 98                         ghi     R8
(1)    13AE : FA 80                      ani     X'80'
(1)    13B0 : 32 BB                      bz      mul16_multiplicand
(1)    13B2 : 98                         ghi     R8
(1)    13B3 : FB FF                      xri     X'FF'
(1)    13B5 : B8                         phi     R8
(1)    13B6 : 88                         glo     R8
(1)    13B7 : FB FF                      xri     X'FF'
(1)    13B9 : A8                         plo     R8
(1)    13BA : 18                         inc     R8              ; negate multiplier
(1)    13BB :                    mul16_multiplicand:
(1)    13BB : 97                         ghi     R7
(1)    13BC : FA 80                      ani     X'80'
(1)    13BE : 32 C9                      bz      mul16_multiply
(1)    13C0 : 97                         ghi     R7
(1)    13C1 : FB FF                      xri     X'FF'
(1)    13C3 : B7                         phi     R7
(1)    13C4 : 87                         glo     R7
(1)    13C5 : FB FF                      xri     X'FF'
(1)    13C7 : A7                         plo     R7
(1)    13C8 : 17                         inc     R7              ; negate multiplicand
(1)    13C9 :                    mul16_multiply:
(1)    13C9 : 68 84 13 7B                scal    R4, umul16
(1)    13CD : 60                         irx
(1)    13CE : F0                         ldx                     ; sign
(1)    13CF : FA 80                      ani     X'80'
(1)    13D1 : 32 DC                      bz      mul16_return
(1)    13D3 : 97                         ghi     R7
(1)    13D4 : FB FF                      xri     X'FF'
(1)    13D6 : B7                         phi     R7
(1)    13D7 : 87                         glo     R7
(1)    13D8 : FB FF                      xri     X'FF'
(1)    13DA : A7                         plo     R7
(1)    13DB : 17                         inc     R7              ; negate result
(1)    13DC :                    mul16_return:
(1)    13DC : 68 94                      sret    R4
(1)    13DE :
(1)    13DE :                    ;;; Unsigned division: dividend / divisor = quotient ... reminder
(1)    13DE :                    ;;; @praram R7 dividend
(1)    13DE :                    ;;; @praram R8 divisor
(1)    13DE :                    ;;; @return R7 quotient
(1)    13DE :                    ;;; @return R8 reminder
(1)    13DE :                    ;;; @clobber R7 R8 R15
(1)    13DE :                    udiv16:
(1)    13DE : 98                         ghi     R8
(1)    13DF : 3A E6                      bnz     udiv16_calc
(1)    13E1 : 88                         glo     R8
(1)    13E2 : 3A E6                      bnz     udiv16_calc
(1)    13E4 : 68 94                      sret    R4
(1)    13E6 :                    udiv16_calc:
(1)    13E6 : 68 A9                      rsxd    R9              ; save R9
(1)    13E8 : F8 01                      ldi     1
(1)    13EA : AF                         plo     R15             ; R15.0=bits
(1)    13EB : 30 F4                      br      udiv16_prep
(1)    13ED :                    udiv16_prep_loop:
(1)    13ED : 88                         glo     R8
(1)    13EE : FE                         shl
(1)    13EF : A8                         plo     R8
(1)    13F0 : 98                         ghi     R8
(1)    13F1 : 7E                         shlc
(1)    13F2 : B8                         phi     R8              ; divisor <<= 1
(1)    13F3 : 1F                         inc     R15             ; ++bits
(1)    13F4 :                    udiv16_prep:
(1)    13F4 : 98                         ghi     R8
(1)    13F5 : FA 80                      ani     X'80'
(1)    13F7 : 32 ED                      bz      udiv16_prep_loop ; while msb(divisor) == 0
(1)    13F9 : 97                         ghi     R7
(1)    13FA : B9                         phi     R9
(1)    13FB : 87                         glo     R7
(1)    13FC : A9                         plo     R9              ; R9=dividend
(1)    13FD : F8 00                      ldi     0
(1)    13FF : B7                         phi     R7
(1)    1400 : A7                         plo     R7              ; R7=quotient
(1)    1401 : 30 0F                      br      udiv16_enter_loop
(1)    1403 :                    udiv16_loop:
(1)    1403 : 98                         ghi     R8
(1)    1404 : F6                         shr
(1)    1405 : B8                         phi     R8
(1)    1406 : 88                         glo     R8
(1)    1407 : 76                         shrc
(1)    1408 : A8                         plo     R8              ; divisor >>= 1
(1)    1409 : 87                         glo     R7
(1)    140A : FE                         shl
(1)    140B : A7                         plo     R7
(1)    140C : 97                         ghi     R7
(1)    140D : 7E                         shlc
(1)    140E : B7                         phi     R7              ; quotient <<= 1
(1)    140F :                    udiv16_enter_loop:
(1)    140F : 88                         glo     R8
(1)    1410 : 52                         str     R2
(1)    1411 : 89                         glo     R9
(1)    1412 : F7                         sm
(1)    1413 : A9                         plo     R9
(1)    1414 : 98                         ghi     R8
(1)    1415 : 52                         str     R2
(1)    1416 : 99                         ghi     R9
(1)    1417 : 77                         smb
(1)    1418 : B9                         phi     R9              ; dividend-=divisor
(1)    1419 : 3B 1E                      bm      udiv16_readd    ; branch if dividend < 0
(1)    141B : 17                         inc     R7              ; quotient += 1
(1)    141C : 30 28                      br      udiv16_next
(1)    141E :                    udiv16_readd:
(1)    141E : 88                         glo     R8
(1)    141F : 52                         str     R2
(1)    1420 : 89                         glo     R9
(1)    1421 : F4                         add
(1)    1422 : A9                         plo     R9
(1)    1423 : 98                         ghi     R8
(1)    1424 : 52                         str     R2
(1)    1425 : 99                         ghi     R9
(1)    1426 : 74                         adc
(1)    1427 : B9                         phi     R9              ; dividend+=divisor
(1)    1428 :                    udiv16_next:
(1)    1428 : 2F                         dec     R15
(1)    1429 : 8F                         glo     R15
(1)    142A : 3A 03                      bnz     udiv16_loop     ; while bits != 0
(1)    142C : 99                         ghi     R9
(1)    142D : B8                         phi     R8
(1)    142E : 89                         glo     R9
(1)    142F : A8                         plo     R8              ; R8=reminder
(1)    1430 : 60                         irx
(1)    1431 : 68 69                      rlxa    R9              ; restore R9
(1)    1433 : 22                         dec     R2
(1)    1434 : 68 94                      sret    R4
(1)    1436 :
(1)    1436 :                    ;;; Signed division: dividend / divisor = quotient ... reminder
(1)    1436 :                    ;;; @param R7 dividend
(1)    1436 :                    ;;; @param R8 divisor
(1)    1436 :                    ;;; @return R7 quotient
(1)    1436 :                    ;;; @return R8 reminder
(1)    1436 :                    ;;;   SCAL R4, duvsi2
(1)    1436 :                    ;;;   SEP R5
(1)    1436 :                    ;;;   DC  A(div16)
(1)    1436 :                    ;;; @clobber R15
(1)    1436 :                    div16:
(1)    1436 : 98                         ghi     R8
(1)    1437 : 52                         str     R2
(1)    1438 : 97                         ghi     R7
(1)    1439 : F3                         xor
(1)    143A : 73                         stxd                    ; push sign
(1)    143B : 98                         ghi     R8
(1)    143C : FA 80                      ani     X'80'
(1)    143E : 32 49                      bz      div16_dividend
(1)    1440 : 98                         ghi     R8
(1)    1441 : FB FF                      xri     X'FF'
(1)    1443 : B8                         phi     R8
(1)    1444 : 88                         glo     R8
(1)    1445 : FB FF                      xri     X'FF'
(1)    1447 : A8                         plo     R8
(1)    1448 : 18                         inc     R8              ; negate divisor
(1)    1449 :                    div16_dividend:
(1)    1449 : 97                         ghi     R7              ; R7=dividend
(1)    144A : FA 80                      ani     X'80'
(1)    144C : 32 57                      bz      div16_divide
(1)    144E : 97                         ghi     R7
(1)    144F : FB FF                      xri     X'FF'
(1)    1451 : B7                         phi     R7
(1)    1452 : 87                         glo     R7
(1)    1453 : FB FF                      xri     X'FF'
(1)    1455 : A7                         plo     R7
(1)    1456 : 17                         inc     R7              ; negate dividend
(1)    1457 :                    div16_divide:
(1)    1457 : 68 84 13 DE                scal    R4, udiv16
(1)    145B : 60                         irx
(1)    145C : F0                         ldx                     ; pop sign
(1)    145D : FA 80                      ani     X'80'
(1)    145F : 32 6A                      bz      div16_return
(1)    1461 : 97                         ghi     R7
(1)    1462 : FB FF                      xri     X'FF'
(1)    1464 : B7                         phi     R7
(1)    1465 : 87                         glo     R7
(1)    1466 : FB FF                      xri     X'FF'
(1)    1468 : A7                         plo     R7
(1)    1469 : 17                         inc     R7              ; negate quotient
(1)    146A :                    div16_return:
(1)    146A : 68 94                      sret    R4
       146C :
       146C :                            end
