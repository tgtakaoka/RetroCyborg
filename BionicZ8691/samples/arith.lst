          0 :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
          0 :                            cpu     z86c
          0 :                            option  "reg-alias", "disable"
          0 :
          0 :                            include "z8.inc"
(1)       0 :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
(1)       0 :                    ;;; Z8
(1)       0 : =FC                FLAGS:  equ     252               ; R/W: Flags register
(1)       0 : =80                F_CARRY:        equ     %(2)10000000 ; set to 1 if carry
(1)       0 : =40                F_ZERO:         equ     %(2)01000000 ; set to 1 if zero
(1)       0 : =20                F_SIGN:         equ     %(2)00100000 ; set to 1 if negative
(1)       0 : =10                F_OVERFLOW:     equ     %(2)00010000 ; set to 1 if overflow
(1)       0 : =8                 F_DECIMAL_ADJ:  equ     %(2)00001000 ; decimal adjust
(1)       0 : =4                 F_HALF_CARRY:   equ     %(2)00000100 ; set to 1 if carry from bit-3
(1)       0 : =2                 F_USER2:        equ     %(2)00000010 ; User flag F2
(1)       0 : =1                 F_USER1:        equ     %(2)00000001 ; User flah F1
(1)       0 :                    ;;; Interrupt vectors
(1)       0 : =0                 VEC_IRQ0:       equ     %0000   ; IRQ0
(1)       0 : =2                 VEC_IRQ1:       equ     %0002   ; IRQ1
(1)       0 : =4                 VEC_IRQ2:       equ     %0004   ; IRQ2/Tin
(1)       0 : =6                 VEC_IRQ3:       equ     %0006   ; IRQ3/Serial in
(1)       0 : =8                 VEC_IRQ4:       equ     %0008   ; IRQ4/Serial out/T0
(1)       0 : =A                 VEC_IRQ5:       equ     %000A   ; IRQ5/T1
(1)       0 :                    ;;; Reset origin
(1)       0 : =C                 ORG_RESET:      equ     %000C   ; RESET
(1)       0 :                    ;;; I/O Ports
(1)       0 : =2                 PORT2:          equ     2       ; Port 2
(1)       0 : =3                 PORT3:          equ     3       ; Port 3
(1)       0 : =F7                P3M:            equ     247       ; W/O: Port 3 Mode Register
(1)       0 : =80                P3M_PARITY:     equ     %(2)10000000 ; 1=Parity on
(1)       0 : =40                P3M_SERIAL:     equ     %(2)01000000 ; 1=P30 is serial in, P37 is serial out
(1)       0 : =1                 P3M_P2PUSHPULL: equ     %(2)00000001 ; 1=Port 2 is push-pull, 0=open drain
(1)       0 : =F6                P2M:            equ     246       ; W/O: Port 2 Mode Register, 0=output, 1=input
(1)       0 : =F8                P01M:           equ     248       ; W/O: Port 0 and 1 Mode Register
(1)       0 : =82                P01M_P0ADDR:    equ     %(2)10000010 ; Port 0 is A8~A15
(1)       0 : =10                P01M_P1DATA:    equ     %(2)00010000 ; Port 1 is AD0~AD7
(1)       0 : =4                 P01M_INTERNAL:  equ     %(2)00000100 ; Stack is on internal memory
(1)       0 :                    ;;; Interrupt
(1)       0 : =F9                IPR:    equ     249             ; W/O: Interrupt Priority
(1)       0 : =1                 IPR_CAB:        equ     %(2)000001 ; C > A > B
(1)       0 : =8                 IPR_ABC:        equ     %(2)001000 ; A > B > C
(1)       0 : =9                 IPR_ACB:        equ     %(2)001001 ; A > C > B
(1)       0 : =10                IPR_BCA:        equ     %(2)010000 ; B > C > A
(1)       0 : =11                IPR_CBA:        equ     %(2)010001 ; C > B > A
(1)       0 : =18                IPR_BAC:        equ     %(2)011000 ; B > A > C
(1)       0 : =0                 IPR_A53:        equ     %(2)000000 ; A: IRQ5 > IRQ3
(1)       0 : =20                IPR_A35:        equ     %(2)100000 ; A: IRQ3 > IRQ5
(1)       0 : =0                 IPR_B20:        equ     %(2)000000 ; B: IRQ2 > IRQ0
(1)       0 : =4                 IPR_B02:        equ     %(2)000100 ; B: IRQ0 > IRQ2
(1)       0 : =0                 IPR_C14:        equ     %(2)000000 ; C: IRQ0 > IRQ4
(1)       0 : =2                 IPR_C41:        equ     %(2)000010 ; C: IRQ4 > IRQ0
(1)       0 : =FB                IMR:    equ     251             ; R/W: Interrupt Mask
(1)       0 : =80                IMR_ENABLE:     equ     %(2)10000000 ; Interrupt enable
(1)       0 : =1                 IMR_IRQ0:       equ     (1 SHL 0)
(1)       0 : =2                 IMR_IRQ1:       equ     (1 SHL 1)
(1)       0 : =4                 IMR_IRQ2:       equ     (1 SHL 2)
(1)       0 : =8                 IMR_IRQ3:       equ     (1 SHL 3)
(1)       0 : =10                IMR_IRQ4:       equ     (1 SHL 4)
(1)       0 : =20                IMR_IRQ5:       equ     (1 SHL 5)
(1)       0 : =FA                IRQ:    equ     250             ; R/W: Interrupt Request
(1)       0 : =1                 IRQ_IRQ0:       equ     IMR_IRQ0
(1)       0 : =2                 IRQ_IRQ1:       equ     IMR_IRQ1
(1)       0 : =4                 IRQ_IRQ2:       equ     IMR_IRQ2
(1)       0 : =8                 IRQ_IRQ3:       equ     IMR_IRQ3
(1)       0 : =10                IRQ_IRQ4:       equ     IMR_IRQ4
(1)       0 : =20                IRQ_IRQ5:       equ     IMR_IRQ5
(1)       0 :                    ;;; Counter/Timers
(1)       0 : =F5                PRE0:   equ     245             ; W/O: Prescaler 0 register
(1)       0 : =1                 PRE0_MODULO:    equ     %(2)00000001 ; 1=Modulo-N, 0=Single-pass
(1)       0 : =FC                PRE0_gm:        equ     %(2)11111100 ; Modulo mask
(1)       0 : =2                 PRE0_gp:        equ     2         ; Modulo bit position
(1)       0 : =F3                PRE1:   equ     243               ; W/O: Prescaler 1 register
(1)       0 : =1                 PRE1_MODULO:    equ     %(2)00000001 ; 1=Modulo-N, 0=SinglePass
(1)       0 : =2                 PRE1_INTERNAL:  equ     %(2)00000010 ; 1=T1 internal, 0=T1 external
(1)       0 : =FC                PRE1_gm:        equ     %(2)11111100 ; Modulo mask
(1)       0 : =2                 PRE1_gp:        equ     2         ; Modulo bit position
(1)       0 : =F2                T1:     equ     242               ; R/W: Counter/Timer 1 Register
(1)       0 : =F4                T0:     equ     244               ; R/W: Counter/Timer 0 Register
(1)       0 : =F1                TMR:    equ     241               ; R/W: Timer Mode Register
(1)       0 : =1                 TMR_LOAD_T0:    equ     %(2)00000001 ; 1=Load T0
(1)       0 : =2                 TMR_ENABLE_T0:  equ     %(2)00000010 ; 1=Enable T0
(1)       0 : =4                 TMR_LOAD_T1:    equ     %(2)00000100 ; 1=Load T1
(1)       0 : =8                 TMR_ENABLE_T1:  equ     %(2)00001000 ; 1=Enable T1
(1)       0 : =0                 TMR_TOUT_OFF:   equ     %(2)00000000 ; TOUT off
(1)       0 : =40                TMR_TOUT_T0:    equ     %(2)01000000 ; TOUT=T0
(1)       0 : =80                TMR_TOUT_T1:    equ     %(2)10000000 ; TOUT=T1
(1)       0 : =C0                TMR_TOUT_CLOCK: equ     %(2)11000000 ; TOUT=internal clock
(1)       0 :                    ;;;
(1)       0 : =F0                SIO:    equ     240             ; R/W: Serial I/O Register
(1)       0 : =FD                RP:     equ     253             ; R/W: Register pointer
(1)       0 : =FE                SPH:    equ     254             ; R/W: Stack Pointer High
(1)       0 : =FF                SPL:    equ     255             ; R/W: Stack Pointer Low
          0 :
          0 :                    ;;; i8251 Universal Synchronous/Asynchronous Receiver/Transmitter
          0 : =FF00              USART:  equ     %FF00
          0 : =FF00              USARTD: equ     USART+0         ; Data register
          0 : =FF01              USARTS: equ     USART+1         ; Status register
          0 : =FF01              USARTC: equ     USART+1         ; Control register
          0 :                            include "i8251.inc"
(1)       0 :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
(1)       0 :                    ;;; i8251 USART device emulator.
(1)       0 : =6                 MODE_STOP_gp:   equ     6
(1)       0 : =C0                MODE_STOP_gm:   equ     %(2)11000000
(1)       0 : =40                MODE_STOP1_gc:  equ     (1 SHL MODE_STOP_gp)
(1)       0 : =80                MODE_STOP15_gc: equ     (2 SHL MODE_STOP_gp)
(1)       0 : =C0                MODE_STOP2_gc:  equ     (3 SHL MODE_STOP_gp)
(1)       0 : =20                MODE_EVEN_bm:   equ     %(2)00100000
(1)       0 : =10                MODE_PARITY_bm: equ     %(2)00010000
(1)       0 : =2                 MODE_LEN_gp:    equ     2
(1)       0 : =C                 MODE_LEN_gm:    equ     %(2)00001100
(1)       0 : =0                 MODE_LEN5_gc:   equ     (0 SHL MODE_LEN_gp)
(1)       0 : =4                 MODE_LEN6_gc:   equ     (1 SHL MODE_LEN_gp)
(1)       0 : =8                 MODE_LEN7_gc:   equ     (2 SHL MODE_LEN_gp)
(1)       0 : =C                 MODE_LEN8_gc:   equ     (3 SHL MODE_LEN_gp)
(1)       0 : =0                 MODE_BAUD_gp:   equ     0
(1)       0 : =3                 MODE_BAUD_gm:   equ     %(2)00000011
(1)       0 : =1                 MODE_BAUD_X1:   equ     (1 SHL MODE_BAUD_gp)
(1)       0 : =2                 MODE_BAUD_X16:  equ     (2 SHL MODE_BAUD_gp)
(1)       0 : =3                 MODE_BAUD_X64:  equ     (3 SHL MODE_BAUD_gp)
(1)       0 :                    ;;; Bit Definition of command register
(1)       0 : =80                CMD_EH_bm:      equ     %(2)10000000   ; Enter hunt mode
(1)       0 : =40                CMD_IR_bm:      equ     %(2)01000000   ; Internal Reset
(1)       0 : =20                CMD_RTS_bm:     equ     %(2)00100000   ; Request To Send
(1)       0 : =10                CMD_ER_bm:      equ     %(2)00010000   ; Error Reset
(1)       0 : =8                 CMD_SBRK_bm:    equ     %(2)00001000   ; Send Break
(1)       0 : =4                 CMD_RxEN_bm:    equ     %(2)00000100   ; Receive Enable
(1)       0 : =2                 CMD_DTR_bm:     equ     %(2)00000010   ; Data Terminal Ready
(1)       0 : =1                 CMD_TxEN_bm:    equ     %(2)00000001   ; Transmit enable
(1)       0 :                    ;;; Bit definition of status register
(1)       0 : =80                ST_DSR_bm:      equ     %(2)10000000   ; Data Set Ready
(1)       0 : =40                ST_BRK_bm:      equ     %(2)01000000   ; BREAK detected
(1)       0 : =20                ST_FE_bm:       equ     %(2)00100000   ; Framing Error
(1)       0 : =10                ST_OE_bm:       equ     %(2)00010000   ; Iverrun Error
(1)       0 : =8                 ST_PE_bm:       equ     %(2)00001000   ; Parity Error
(1)       0 : =4                 ST_TxEMPTY_bm:  equ     %(2)00000100   ; Transmitter empty
(1)       0 : =2                 ST_RxRDY_bm:    equ     %(2)00000010   ; Receiver ready
(1)       0 : =1                 ST_TxRDY_bm:    equ     %(2)00000001   ; Transmitter ready
(1)       0 :                    ;;; Interrupt name for receive/transmit interrupt
(1)       0 : =0                 INTR_NONE:      equ     0
(1)       0 : =1                 INTR_IRQ0:      equ     1
(1)       0 : =2                 INTR_IRQ1:      equ     2
(1)       0 : =3                 INTR_IRQ2:      equ     3
          0 :
       1000 :                            org     %1000
       1000 : =1000              stack:  equ     $
       1000 :
          C :                            org     ORG_RESET
          C : 8D 01 00                   jp      init_config
          F :
        100 :                            org     %0100
        100 :                    init_config:
        100 : 31 F0                      srp     #%F0
        102 :                            setrp   %F0
        102 :                            ;; Stack is on external memory
        102 : 8C 92                      ld      P01M, #P01M_P0ADDR LOR P01M_P1DATA
        104 : 6C FF                      ld      P2M, #%FF       ; Port 2 is input
        106 : EC 10                      ld      SPH, #HIGH stack
        108 : FC 00                      ld      SPL, #LOW stack
        10A :
        10A :                    init_usart:
        10A : 31 10                      srp     #%10
        10C :                            setrp   %10
        10C : CC FF                      ld      r12, #HIGH USARTC
        10E : DC 01                      ld      r13, #LOW USARTC
        110 : B0 E0                      clr     r0
        112 : 92 0C                      lde     @rr12, r0
        114 : 92 0C                      lde     @rr12, r0
        116 : 92 0C                      lde     @rr12, r0       ; safest way to sync mode
        118 : 0C 40                      ld      r0, #CMD_IR_bm
        11A : 92 0C                      lde     @rr12, r0       ; reset
        11C : FF                         nop
        11D : FF                         nop
        11E : 0C 4E                      ld      r0, #MODE_STOP1_gc LOR MODE_LEN8_gc LOR MODE_BAUD_X16
        120 : 92 0C                      lde     @rr12, r0       ; async 1stop 8data x16
        122 : FF                         nop
        123 : FF                         nop
        124 : 0C 37                      ld      r0, #CMD_RTS_bm LOR CMD_DTR_bm LOR CMD_ER_bm LOR CMD_RxEN_bm LOR CMD_TxEN_bm
        126 : 92 0C                      lde     @rr12, r0 ; RTS/DTR, error reset, Rx enable, Tx enable
        128 : 8C FF                      ld      r8, #HIGH USARTD
        12A : 9C 00                      ld      r9, #LOW USARTD
        12C :
        12C : 8D 10 00                   jp      arith
        12F :
        12F :                    putchar:
        12F : 70 E0                      push    r0
        131 : A0 E8                      incw    rr8
        133 :                    putchar_loop:   
        133 : 82 08                      lde     r0, @rr8
        135 : 76 E0 01                   tm      r0, #ST_TxRDY_bm
        138 : 6B F9                      jr      z, putchar_loop
        13A : 50 E0                      pop     r0
        13C : 80 E8                      decw    rr8
        13E : 92 08                      lde     @rr8, r0
        140 : AF                         ret
        141 :
        141 :                    newline:
        141 : 70 E0                      push    r0
        143 : 0C 0D                      ld      r0, #%0D
        145 : D6 01 2F                   call    putchar
        148 : 0C 0A                      ld      r0, #%0A
        14A : D6 01 2F                   call    putchar
        14D : 50 E0                      pop     r0
        14F : AF                         ret
        150 :
        150 :                    putspace:
        150 : 70 E0                      push    r0
        152 : 0C 20                      ld      r0, #' '
        154 : D6 01 2F                   call    putchar
        157 : 50 E0                      pop     r0
        159 : AF                         ret
        15A :
        15A :                    ;;; Print unsigned 16-bit integer as decimal
        15A :                    ;;; @param rr0: value
        15A :                    ;;; @clobber rr0 rr12 rr14
        15A :                    print_uint16:
        15A : A0 E0                      incw    rr0
        15C : 80 E0                      decw    rr0
        15E : EB 06                      jr      nz, print_uint16_inner
        160 : 0C 30                      ld      r0, #'0'
        162 : D6 01 2F                   call    putchar
        165 :                    print_uint16_end:
        165 : AF                         ret
        166 :                    print_uint16_inner:
        166 : A0 E0                      incw    rr0
        168 : 80 E0                      decw    rr0
        16A : 6B F9                      jr      z, print_uint16_end
        16C : E8 E0                      ld      r14, r0
        16E : F8 E1                      ld      r15, r1
        170 : CC 00                      ld      r12, #HIGH 10
        172 : DC 0A                      ld      r13, #LOW 10
        174 : D6 12 C6                   call    udiv16
        177 : 70 EF                      push    r15
        179 : 08 EC                      ld      r0, r12
        17B : 18 ED                      ld      r1, r13
        17D : D6 01 66                   call    print_uint16_inner
        180 : 50 E0                      pop     r0
        182 : 06 E0 30                   add     r0, #'0'
        185 : 8B A8                      jr      putchar
        187 :
        187 :                    ;;; Print signed 16-bit integer as decimal
        187 :                    ;;; @param rr0: value
        187 :                    ;;; @clobber rr0
        187 :                    print_int16:
        187 : 42 00                      or      r0, r0
        189 : DB CF                      jr      pl, print_uint16
        18B : 70 E0                      push    r0
        18D : 0C 2D                      ld      r0, #'-'
        18F : D6 01 2F                   call    putchar
        192 : 50 E0                      pop     r0
        194 : 60 E1                      com     r1
        196 : 60 E0                      com     r0
        198 : A0 E0                      incw    rr0
        19A : 8D 01 5A                   jp      print_uint16
        19D :
        19D :                    putflags:
        19D : 18 FC                      ld      r1, FLAGS
        19F : 76 E1 F0                   tm      r1, #F_CARRY LOR F_ZERO LOR F_SIGN LOR F_OVERFLOW
        1A2 : EB 01                      jr      nz, putflags_spc
        1A4 : AF                         ret
        1A5 :                    putflags_spc:
        1A5 : D6 01 50                   call    putspace
        1A8 : 19 FC                      ld      FLAGS, r1
        1AA : FB 05                      jr      nc, putflags_nc
        1AC : 0C 43                      ld      r0, #'C'
        1AE : D6 01 2F                   call    putchar
        1B1 :                    putflags_nc:
        1B1 : 19 FC                      ld      FLAGS, r1
        1B3 : EB 05                      jr      nz, putflags_nz
        1B5 : 0C 5A                      ld      r0, #'Z'
        1B7 : D6 01 2F                   call    putchar
        1BA :                    putflags_nz:
        1BA : 19 FC                      ld      FLAGS, r1
        1BC : DB 05                      jr      pl, putflags_pl
        1BE : 0C 53                      ld      r0, #'S'
        1C0 : D6 01 2F                   call    putchar
        1C3 :                    putflags_pl:
        1C3 : 19 FC                      ld      FLAGS, r1
        1C5 : CB 05                      jr      nov, putflags_nov
        1C7 : 0C 56                      ld      r0, #'V'
        1C9 : D6 01 2F                   call    putchar
        1CC :                    putflags_nov:
        1CC : AF                         ret
        1CD :
        1CD :                    expr:
        1CD : 70 E0                      push    r0
        1CF : 08 40                      ld      r0, a
        1D1 : 18 41                      ld      r1, a+1
        1D3 : D6 01 87                   call    print_int16
        1D6 : D6 01 50                   call    putspace
        1D9 : 50 E0                      pop     r0
        1DB : D6 01 2F                   call    putchar
        1DE : D6 01 50                   call    putspace
        1E1 : 08 42                      ld      r0, b
        1E3 : 18 43                      ld      r1, b+1
        1E5 : 8D 01 87                   jp      print_int16
        1E8 :
        1E8 :                    answer:
        1E8 : D6 01 50                   call    putspace
        1EB : 0C 3D                      ld      r0, #'='
        1ED : D6 01 2F                   call    putchar
        1F0 : D6 01 50                   call    putspace
        1F3 : 08 40                      ld      r0, a
        1F5 : 18 41                      ld      r1, a+1
        1F7 : D6 01 87                   call    print_int16
        1FA : 8D 01 41                   jp      newline
        1FD :
        1FD :                    comp:
        1FD : 4C 40                      ld      r4, #a
        1FF : 5C 42                      ld      r5, #b
        201 : D6 12 26                   call    cmpsi2
        204 : 70 FC                      push    FLAGS
        206 : AB 08                      jr      gt, comp_gt
        208 : 6B 0A                      jr      eq, comp_eq
        20A : 1B 0C                      jr      lt, comp_lt
        20C : 0C 3F                      ld      r0, #'?'
        20E : 8B 0A                      jr      comp_out
        210 :                    comp_gt:
        210 : 0C 3E                      ld      r0, #'>'
        212 : 8B 06                      jr      comp_out
        214 :                    comp_eq:
        214 : 0C 3D                      ld      r0, #'='
        216 : 8B 02                      jr      comp_out
        218 :                    comp_lt:
        218 : 0C 3C                      ld      r0, #'<'
        21A :                    comp_out:
        21A : D6 01 CD                   call    expr
        21D : 50 FC                      pop     FLAGS
        21F : D6 01 9D                   call    putflags
        222 : 8D 01 41                   jp      newline
        225 :
         40 :                            org     %40
         40 :                    a:      ds      2
         42 :                    b:      ds      2
         44 :
       1000 :                            org     %1000
       1000 :
       1000 :                    arith:
       1000 : 4C 40                      ld      r4, #a
       1002 : 5C 42                      ld      r5, #b
       1004 :
       1004 : E6 40 00                   ld      a, #0
       1007 : E6 41 00                   ld      a+1, #0
       100A : E6 42 92                   ld      b, #HIGH -28000
       100D : E6 43 A0                   ld      b+1, #LOW -28000
       1010 : 0C 2D                      ld      r0, #'-'
       1012 : D6 01 CD                   call    expr
       1015 : D6 11 F1                   call    negsi2
       1018 : D6 01 E8                   call    answer          ; 28000
       101B :
       101B : E6 40 00                   ld      a, #0
       101E : E6 41 00                   ld      a+1, #0
       1021 : E6 42 6D                   ld      b, #HIGH 28000
       1024 : E6 43 60                   ld      b+1, #LOW 28000
       1027 : 0C 2D                      ld      r0, #'-'
       1029 : D6 01 CD                   call    expr
       102C : D6 11 F1                   call    negsi2
       102F : D6 01 E8                   call    answer          ; -28000
       1032 :
       1032 : E6 40 46                   ld      a, #HIGH 18000
       1035 : E6 41 50                   ld      a+1, #LOW 18000
       1038 : E6 42 6D                   ld      b, #HIGH 28000
       103B : E6 43 60                   ld      b+1, #LOW 28000
       103E : 0C 2B                      ld      r0, #'+'
       1040 : D6 01 CD                   call    expr
       1043 : D6 12 02                   call    addsi2
       1046 : D6 01 E8                   call    answer          ; -19536
       1049 :
       1049 : E6 40 46                   ld      a, #HIGH 18000
       104C : E6 41 50                   ld      a+1, #LOW 18000
       104F : E6 42 B9                   ld      b, #HIGH -18000
       1052 : E6 43 B0                   ld      b+1, #LOW -18000
       1055 : 0C 2B                      ld      r0, #'+'
       1057 : D6 01 CD                   call    expr
       105A : D6 12 02                   call    addsi2
       105D : D6 01 E8                   call    answer          ; 0
       1060 :
       1060 : E6 40 92                   ld      a, #HIGH -28000
       1063 : E6 41 A0                   ld      a+1, #LOW -28000
       1066 : 0C 2B                      ld      r0, #'+'
       1068 : D6 01 CD                   call    expr
       106B : D6 12 02                   call    addsi2
       106E : D6 01 E8                   call    answer          ; 29536
       1071 :
       1071 : E6 40 46                   ld      a, #HIGH 18000
       1074 : E6 41 50                   ld      a+1, #LOW 18000
       1077 : E6 42 92                   ld      b, #HIGH -28000
       107A : E6 43 A0                   ld      b+1, #LOW -28000
       107D : 0C 2D                      ld      r0, #'-'
       107F : D6 01 CD                   call    expr
       1082 : D6 12 14                   call    subsi2
       1085 : D6 01 E8                   call    answer          ; -19536
       1088 :
       1088 : E6 40 46                   ld      a, #HIGH 18000
       108B : E6 41 50                   ld      a+1, #LOW 18000
       108E : E6 42 B9                   ld      b, #HIGH -18000
       1091 : E6 43 B0                   ld      b+1, #LOW -18000
       1094 : 0C 2D                      ld      r0, #'-'
       1096 : D6 01 CD                   call    expr
       1099 : D6 12 14                   call    subsi2
       109C : D6 01 E8                   call    answer          ; 29536
       109F :
       109F : E6 40 92                   ld      a, #HIGH -28000
       10A2 : E6 41 A0                   ld      a+1, #LOW -28000
       10A5 : 0C 2D                      ld      r0, #'-'
       10A7 : D6 01 CD                   call    expr
       10AA : D6 12 14                   call    subsi2
       10AD : D6 01 E8                   call    answer          ; -10000
       10B0 :
       10B0 : E6 40 01                   ld      a, #HIGH 300
       10B3 : E6 41 2C                   ld      a+1, #LOW 300
       10B6 : E6 42 FF                   ld      b, #HIGH -200
       10B9 : E6 43 38                   ld      b+1, #LOW -200
       10BC : 0C 2A                      ld      r0, #'*'
       10BE : D6 01 CD                   call    expr
       10C1 : D6 12 93                   call    mulsi2
       10C4 : D6 01 E8                   call    answer          ; 5536
       10C7 :
       10C7 : E6 40 00                   ld      a, #HIGH 100
       10CA : E6 41 64                   ld      a+1, #LOW 100
       10CD : E6 42 FE                   ld      b, #HIGH -300
       10D0 : E6 43 D4                   ld      b+1, #LOW -300
       10D3 : 0C 2A                      ld      r0, #'*'
       10D5 : D6 01 CD                   call    expr
       10D8 : D6 12 93                   call    mulsi2
       10DB : D6 01 E8                   call    answer          ; -30000
       10DE :
       10DE : E6 40 FF                   ld      a, #HIGH -200
       10E1 : E6 41 38                   ld      a+1, #LOW -200
       10E4 : E6 42 FF                   ld      b, #HIGH -100
       10E7 : E6 43 9C                   ld      b+1, #LOW -100
       10EA : 0C 2A                      ld      r0, #'*'
       10EC : D6 01 CD                   call    expr
       10EF : D6 12 93                   call    mulsi2
       10F2 : D6 01 E8                   call    answer          ; 20000
       10F5 :
       10F5 : E6 40 FF                   ld      a, #HIGH -200
       10F8 : E6 41 38                   ld      a+1, #LOW -200
       10FB : E6 42 00                   ld      b, #HIGH 100
       10FE : E6 43 64                   ld      b+1, #LOW 100
       1101 : 0C 2F                      ld      r0, #'/'
       1103 : D6 01 CD                   call    expr
       1106 : D6 13 1A                   call    divsi2
       1109 : D6 01 E8                   call    answer          ; -2
       110C :
       110C : E6 40 75                   ld      a, #HIGH 30000
       110F : E6 41 30                   ld      a+1, #LOW 30000
       1112 : 0C 2F                      ld      r0, #'/'
       1114 : D6 01 CD                   call    expr
       1117 : D6 13 1A                   call    divsi2
       111A : D6 01 E8                   call    answer          ; 30
       111D :
       111D : E6 40 8A                   ld      a, #HIGH -30000
       1120 : E6 41 D0                   ld      a+1, #LOW -30000
       1123 : E6 42 FF                   ld      b, #HIGH -200
       1126 : E6 43 38                   ld      b+1, #LOW -200
       1129 : 0C 2F                      ld      r0, #'/'
       112B : D6 01 CD                   call    expr
       112E : D6 13 1A                   call    divsi2
       1131 : D6 01 E8                   call    answer          ; 150
       1134 :
       1134 : E6 40 8A                   ld      a, #HIGH -30000
       1137 : E6 41 D0                   ld      a+1, #LOW -30000
       113A : E6 42 00                   ld      b, #HIGH 78
       113D : E6 43 4E                   ld      b+1, #LOW 78
       1140 : 0C 2F                      ld      r0, #'/'
       1142 : D6 01 CD                   call    expr
       1145 : D6 13 1A                   call    divsi2
       1148 : D6 01 E8                   call    answer          ; -384
       114B :
       114B : E6 40 13                   ld      a, #HIGH 5000
       114E : E6 41 88                   ld      a+1, #LOW 5000
       1151 : E6 42 0F                   ld      b, #HIGH 4000
       1154 : E6 43 A0                   ld      b+1, #LOW 4000
       1157 : D6 01 FD                   call    comp
       115A :
       115A : E6 42 13                   ld      b, #HIGH 5000
       115D : E6 43 88                   ld      b+1, #LOW 5000
       1160 : D6 01 FD                   call    comp
       1163 :
       1163 : E6 40 0F                   ld      a, #HIGH 4000
       1166 : E6 41 A0                   ld      a+1, #LOW 4000
       1169 : D6 01 FD                   call    comp
       116C :
       116C : E6 40 EC                   ld      a, #HIGH -5000
       116F : E6 41 78                   ld      a+1, #LOW -5000
       1172 : E6 42 F0                   ld      b, #HIGH -4000
       1175 : E6 43 60                   ld      b+1, #LOW -4000
       1178 : D6 01 FD                   call    comp
       117B :
       117B : E6 42 EC                   ld      b, #HIGH -5000
       117E : E6 43 78                   ld      b+1, #LOW -5000
       1181 : D6 01 FD                   call    comp
       1184 :
       1184 : E6 40 F0                   ld      a, #HIGH -4000
       1187 : E6 41 60                   ld      a+1, #LOW -4000
       118A : D6 01 FD                   call    comp
       118D :
       118D : E6 40 7F                   ld      a, #HIGH 32700
       1190 : E6 41 BC                   ld      a+1, #LOW 32700
       1193 : E6 42 7F                   ld      b, #HIGH 32600
       1196 : E6 43 58                   ld      b+1, #LOW 32600
       1199 : D6 01 FD                   call    comp
       119C :
       119C : E6 42 7F                   ld      b, #HIGH 32700
       119F : E6 43 BC                   ld      b+1, #LOW 32700
       11A2 : D6 01 FD                   call    comp
       11A5 :
       11A5 : E6 40 7F                   ld      a, #HIGH 32600
       11A8 : E6 41 58                   ld      a+1, #LOW 32600
       11AB : D6 01 FD                   call    comp
       11AE :
       11AE : E6 40 80                   ld      a, #HIGH -32700
       11B1 : E6 41 44                   ld      a+1, #LOW -32700
       11B4 : E6 42 80                   ld      b, #HIGH -32600
       11B7 : E6 43 A8                   ld      b+1, #LOW -32600
       11BA : D6 01 FD                   call    comp
       11BD :
       11BD : E6 42 80                   ld      b, #HIGH -32700
       11C0 : E6 43 44                   ld      b+1, #LOW -32700
       11C3 : D6 01 FD                   call    comp
       11C6 :
       11C6 : E6 40 80                   ld      a, #HIGH -32600
       11C9 : E6 41 A8                   ld      a+1, #LOW -32600
       11CC : D6 01 FD                   call    comp
       11CF :
       11CF : E6 40 46                   ld      a, #HIGH 18000
       11D2 : E6 41 50                   ld      a+1, #LOW 18000
       11D5 : E6 42 92                   ld      b, #HIGH -28000
       11D8 : E6 43 A0                   ld      b+1, #LOW -28000
       11DB : D6 01 FD                   call    comp
       11DE :
       11DE : E6 42 46                   ld      b, #HIGH 18000
       11E1 : E6 43 50                   ld      b+1, #LOW 18000
       11E4 : D6 01 FD                   call    comp
       11E7 :
       11E7 : E6 40 92                   ld      a, #HIGH -28000
       11EA : E6 41 A0                   ld      a+1, #LOW -28000
       11ED : D6 01 FD                   call    comp
       11F0 :
       11F0 : 7F                         halt
       11F1 :
       11F1 :                            include "arith.inc"
(1)    11F1 :                            cpu     z86c
(1)    11F1 :                            option  optimize-index, on
(1)    11F1 :
(1)    11F1 :                    ;;; Negation; result = -value
(1)    11F1 :                    ;;; @param @r4: result
(1)    11F1 :                    ;;; @param @r5: value
(1)    11F1 :                    ;;; @clobber r14, r15
(1)    11F1 :                    negsi2:
(1)    11F1 : E3 E5                      ld      r14, 0(r5)
(1)    11F3 : C7 F5 01                   ld      r15, 1(r5)
(1)    11F6 : 60 EE                      com     r14
(1)    11F8 : 60 EF                      com     r15
(1)    11FA : A0 EE                      incw    rr14
(1)    11FC : F3 4E                      ld      0(r4), r14
(1)    11FE : D7 F4 01                   ld      1(r4), r15
(1)    1201 : AF                         ret
(1)    1202 :
(1)    1202 :                    ;;; Signed addition: summand += addend
(1)    1202 :                    ;;; @param @r4: summand
(1)    1202 :                    ;;; @param @r5: addend
(1)    1202 :                    ;;; @clobber r14, r15
(1)    1202 :                    addsi2:
(1)    1202 : E3 E4                      ld      r14, 0(r4)
(1)    1204 : C7 F4 01                   ld      r15, 1(r4)
(1)    1207 : 5E                         inc     r5
(1)    1208 : 03 F5                      add     r15, @r5
(1)    120A : 00 E5                      dec     r5
(1)    120C : 13 E5                      adc     r14, @r5
(1)    120E : F3 4E                      ld      0(r4), r14
(1)    1210 : D7 F4 01                   ld      1(r4), r15
(1)    1213 : AF                         ret
(1)    1214 :
(1)    1214 :                    ;;; Singed subtraction: minuend -= subtrahend
(1)    1214 :                    ;;; @param @r4: minuend
(1)    1214 :                    ;;; @param @r5: subtrahend
(1)    1214 :                    ;;; @clobber r14, r15
(1)    1214 :                    subsi2:
(1)    1214 : E3 E4                      ld      r14, 0(r4)
(1)    1216 : C7 F4 01                   ld      r15, 1(r4)
(1)    1219 : 5E                         inc     r5
(1)    121A : 23 F5                      sub     r15, @r5
(1)    121C : 00 E5                      dec     r5
(1)    121E : 33 E5                      sbc     r14, @r5
(1)    1220 : F3 4E                      ld      0(r4), r14
(1)    1222 : D7 F4 01                   ld      1(r4), r15
(1)    1225 : AF                         ret
(1)    1226 :
(1)    1226 :                    ;;; Signed comparison: minuend - subtrahend
(1)    1226 :                    ;;; @param @r4: minuend
(1)    1226 :                    ;;; @param @r5: subtrahend
(1)    1226 :                    ;;; @clobber r14, r15
(1)    1226 :                    cmpsi2:
(1)    1226 : E3 E4                      ld      r14, 0(r4)
(1)    1228 : C7 F4 01                   ld      r15, 1(r4)
(1)    122B : 5E                         inc     r5
(1)    122C : 23 F5                      sub     r15, @r5
(1)    122E : 00 E5                      dec     r5
(1)    1230 : 33 E5                      sbc     r14, @r5        ; rr14=@r4-@r5
(1)    1232 : D6 12 36                   call    addsub_flags    ; set C,Z,S,V
(1)    1235 : AF                         ret
(1)    1236 :
(1)    1236 :                    ;;; Set add/sub flags
(1)    1236 :                    ;;; @param @r4: operand 1
(1)    1236 :                    ;;; @param @r5: operand 2
(1)    1236 :                    ;;; @param rr14: result
(1)    1236 :                    ;;; @param FLAGS
(1)    1236 :                    ;;; @return FLAGS: C, Z, S, V
(1)    1236 :                    addsub_flags:
(1)    1236 : 70 EF                      push    r15
(1)    1238 : 70 EE                      push    r14
(1)    123A : 70 ED                      push    r13
(1)    123C : D8 FC                      ld      r13, FLAGS
(1)    123E : 46 ED 50                   or      r13, #F_ZERO LOR F_OVERFLOW ; set Z, V
(1)    1241 : 42 FE                      or      r15, r14
(1)    1243 : 6B 03                      jr      z, addsub_flags_z
(1)    1245 : B6 ED 40                   xor     r13, #F_ZERO    ; clear Z
(1)    1248 :                    addsub_flags_z:
(1)    1248 : B3 E4                      xor     r14, @r4
(1)    124A : B3 E5                      xor     r14, @r5        ; r14:7 carry into S
(1)    124C : FB 03                      jr      nc, addsub_flags_nc
(1)    124E : B6 EE 80                   xor     r14, #%80       ; r14:7=C^(carry into S)
(1)    1251 :                    addsub_flags_nc:
(1)    1251 : 5B 03                      jr      mi, addsub_flags_v
(1)    1253 : B6 ED 10                   xor     r13, #F_OVERFLOW ; clear V
(1)    1256 :                    addsub_flags_v:
(1)    1256 : D9 FC                      ld      FLAGS, r13
(1)    1258 : 50 ED                      pop     r13
(1)    125A : 50 EE                      pop     r14
(1)    125C : 50 EF                      pop     r15
(1)    125E : AF                         ret
(1)    125F :
(1)    125F :                    ;;; Unsigned multiplication: result = multiplicand * multiplier
(1)    125F :                    ;;; @param rr14: multiplicand
(1)    125F :                    ;;; @param rr12: multiplier
(1)    125F :                    ;;; @return rr14: result
(1)    125F :                    ;;; @clobber r10-r15
(1)    125F :                    umul16:
(1)    125F : A8 EE                      ld      r10, r14        ; rr10=multiplicand
(1)    1261 : B8 EF                      ld      r11, r15
(1)    1263 : EC 00                      ld      r14, #0         ; result=0
(1)    1265 : FC 00                      ld      r15, #0
(1)    1267 : 8B 10                      jr      umul16_check
(1)    1269 :                    umul16_loop:
(1)    1269 : CF                         rcf                     ; multiplier >>= 1
(1)    126A : C0 EC                      rrc     r12
(1)    126C : C0 ED                      rrc     r13
(1)    126E : FB 04                      jr      nc, umul16_next ; if lsb(multiplier) == 0
(1)    1270 : 02 FB                      add     r15, r11
(1)    1272 : 12 EA                      adc     r14, r10        ; result += multiplicand
(1)    1274 :                    umul16_next:
(1)    1274 : CF                         rcf                     ; multiplicand <<= 1
(1)    1275 : 10 EB                      rlc     r11
(1)    1277 : 10 EA                      rlc     r10
(1)    1279 :                    umul16_check:
(1)    1279 : A0 EC                      incw    rr12
(1)    127B : 80 EC                      decw    rr12
(1)    127D : EB EA                      jr      nz, umul16_loop ; while multiplier != 0
(1)    127F :                    umul16_end:
(1)    127F : AF                         ret
(1)    1280 :
(1)    1280 :                    ;;; Unsigned multiplication: multiplicand *= multiplier
(1)    1280 :                    ;;; @param @r4: multiplicand
(1)    1280 :                    ;;; @param @r5: multiplier
(1)    1280 :                    ;;; @clobber r10-r15
(1)    1280 :                    umulsi2:
(1)    1280 : E3 E4                      ld      r14, 0(r4)
(1)    1282 : C7 F4 01                   ld      r15, 1(r4)
(1)    1285 : E3 C5                      ld      r12, 0(r5)
(1)    1287 : C7 D5 01                   ld      r13, 1(r5)
(1)    128A : D6 12 5F                   call    umul16          ; rr10=multiplicand * multiplier
(1)    128D : F3 4E                      ld      0(r4), r14
(1)    128F : D7 F4 01                   ld      1(r4), r15
(1)    1292 : AF                         ret
(1)    1293 :
(1)    1293 :                    ;;; Signed multiplication: multiplicand *= multiplier
(1)    1293 :                    ;;; @param @r4: multiplicand
(1)    1293 :                    ;;; @param @r5: multiplier
(1)    1293 :                    ;;; @clobber r10-r15
(1)    1293 :                    mulsi2:
(1)    1293 : E3 E4                      ld      r14, 0(r4)
(1)    1295 : C7 F4 01                   ld      r15, 1(r4)
(1)    1298 : E3 C5                      ld      r12, 0(r5)
(1)    129A : C7 D5 01                   ld      r13, 1(r5)
(1)    129D : 42 CC                      or      r12, r12
(1)    129F : DB 06                      jr      pl, mulsi2_abs_muliplicand
(1)    12A1 : 60 EC                      com     r12
(1)    12A3 : 60 ED                      com     r13
(1)    12A5 : A0 EC                      incw    rr12            ; multiplicand = -multiplicand
(1)    12A7 :                    mulsi2_abs_muliplicand:
(1)    12A7 : 42 EE                      or      r14, r14
(1)    12A9 : DB 06                      jr      pl, mulsi2_multiply
(1)    12AB : 60 EE                      com     r14
(1)    12AD : 60 EF                      com     r15
(1)    12AF : A0 EE                      incw    rr14            ; multiplier = -multiplier
(1)    12B1 :                    mulsi2_multiply:
(1)    12B1 : D6 12 5F                   call    umul16          ; result = multiplicand * multiplier
(1)    12B4 : E3 C4                      ld      r12, @r4
(1)    12B6 : B3 C5                      xor     r12, @r5        ; r12=sign(@r4)^sign(@r5)
(1)    12B8 : DB 06                      jr      pl, mulsi2_end
(1)    12BA : 60 EE                      com     r14
(1)    12BC : 60 EF                      com     r15
(1)    12BE : A0 EE                      incw    rr14            ; result = -result
(1)    12C0 :                    mulsi2_end:
(1)    12C0 : F3 4E                      ld      0(r4), r14
(1)    12C2 : D7 F4 01                   ld      1(r4), r15
(1)    12C5 : AF                         ret
(1)    12C6 :
(1)    12C6 :                    ;;; Unsigned division: divident / divisor = quotient ... reminder
(1)    12C6 :                    ;;; @praram rr14: divident
(1)    12C6 :                    ;;; @praram rr12: divisor
(1)    12C6 :                    ;;; @return rr14: reminder
(1)    12C6 :                    ;;; @return rr12: quotient
(1)    12C6 :                    ;;; @clobber r10-r15
(1)    12C6 :                    udiv16:
(1)    12C6 : 70 E9                      push    r9
(1)    12C8 : A0 EC                      incw    rr12
(1)    12CA : 80 EC                      decw    rr12
(1)    12CC : 6D 13 04                   jp      z, udiv16_end
(1)    12CF : 9C 01                      ld      r9, #1          ; r9=bits
(1)    12D1 : 8D 12 DA                   jp      udiv16_prep
(1)    12D4 :                    udiv16_prep_loop:
(1)    12D4 : CF                         rcf                     ; divisor <<= 1
(1)    12D5 : 10 ED                      rlc     r13
(1)    12D7 : 10 EC                      rlc     r12
(1)    12D9 : 9E                         inc     r9
(1)    12DA :                    udiv16_prep:                    ; while msb(divisor) == 0
(1)    12DA : 42 CC                      or      r12, r12
(1)    12DC : DB F6                      jr      pl, udiv16_prep_loop
(1)    12DE : AC 00                      ld      r10, #0
(1)    12E0 : BC 00                      ld      r11, #0         ; rr10=quotient
(1)    12E2 : 8D 12 EF                   jp      udiv16_enter_loop
(1)    12E5 :                    udiv16_loop:
(1)    12E5 : CF                         rcf                     ; divisor >>= 1
(1)    12E6 : C0 EC                      rrc     r12
(1)    12E8 : C0 ED                      rrc     r13
(1)    12EA : CF                         rcf                     ; quotient <<= 1
(1)    12EB : 10 EB                      rlc     r11
(1)    12ED : 10 EA                      rlc     r10
(1)    12EF :                    udiv16_enter_loop:
(1)    12EF : 22 FD                      sub     r15, r13        ; divident -= divisor
(1)    12F1 : 32 EC                      sbc     r14, r12
(1)    12F3 : 7D 12 FA                   jp      c, udiv16_readd ; if divident < 0
(1)    12F6 : BE                         inc     r11             ; quotient |= 1
(1)    12F7 : 8D 12 FE                   jp      udiv16_next
(1)    12FA :                    udiv16_readd:
(1)    12FA : 02 FD                      add     r15, r13        ; divident += divisor
(1)    12FC : 12 EC                      adc     r14, r12        ; FLAG.D is always cleared
(1)    12FE :                    udiv16_next:
(1)    12FE : 9A E5                      djnz    r9, udiv16_loop ; rr14=reminder
(1)    1300 : C8 EA                      ld      r12, r10        ; rr12=quotient
(1)    1302 : D8 EB                      ld      r13, r11
(1)    1304 :                    udiv16_end:
(1)    1304 : 50 E9                      pop     r9
(1)    1306 : AF                         ret
(1)    1307 :
(1)    1307 :                    ;;; Unsigned division: dividend /= divisor
(1)    1307 :                    ;;; @praram @r4: dividend
(1)    1307 :                    ;;; @praram @r5: divisor
(1)    1307 :                    ;;; @clobber r10-r15
(1)    1307 :                    udivsi2:
(1)    1307 : E3 E4                      ld      r14, 0(r4)
(1)    1309 : C7 F4 01                   ld      r15, 1(r4)
(1)    130C : E3 C5                      ld      r12, 0(r5)
(1)    130E : C7 D5 01                   ld      r13, 1(r5)
(1)    1311 : D6 12 C6                   call    udiv16
(1)    1314 : F3 4C                      ld      0(r4), r12
(1)    1316 : D7 D4 01                   ld      1(r4), r13
(1)    1319 : AF                         ret
(1)    131A :
(1)    131A :                    ;;; Signed division: divident *= divisor
(1)    131A :                    ;;; @param @r4: divident
(1)    131A :                    ;;; @param @r5: divisor
(1)    131A :                    ;;; @clobber r10-r15
(1)    131A :                    divsi2:
(1)    131A : E3 E4                      ld      r14, 0(r4)
(1)    131C : C7 F4 01                   ld      r15, 1(r4)
(1)    131F : E3 C5                      ld      r12, 0(r5)
(1)    1321 : C7 D5 01                   ld      r13, 1(r5)
(1)    1324 : 42 EE                      or      r14, r14
(1)    1326 : DB 06                      jr      pl, divsi2_abs_divident
(1)    1328 : 60 EE                      com     r14
(1)    132A : 60 EF                      com     r15
(1)    132C : A0 EE                      incw    rr14            ; divident = -divident
(1)    132E :                    divsi2_abs_divident:
(1)    132E : 42 CC                      or      r12, r12
(1)    1330 : DB 06                      jr      pl, divsi2_divide
(1)    1332 : 60 EC                      com     r12
(1)    1334 : 60 ED                      com     r13
(1)    1336 : A0 EC                      incw    rr12            ; divisor = -divisor
(1)    1338 :                    divsi2_divide:
(1)    1338 : D6 12 C6                   call    udiv16
(1)    133B : E3 E4                      ld      r14, @r4
(1)    133D : B3 E5                      xor     r14, @r5        ; r14=sign(@r4)^sign(@r5)
(1)    133F : DB 06                      jr      pl, divsi2_end
(1)    1341 : 60 EC                      com     r12
(1)    1343 : 60 ED                      com     r13
(1)    1345 : A0 EC                      incw    rr12            ; divident = = -divident
(1)    1347 :                    divsi2_end:
(1)    1347 : F3 4C                      ld      0(r4), r12
(1)    1349 : D7 D4 01                   ld      1(r4), r13
(1)    134C : AF                         ret
(1)    134D :
(1)    134D :                    ;;; Local Variables:
(1)    134D :                    ;;; mode: asm
(1)    134D :                    ;;; End:
(1)    134D :                    ;;; vim: set ft=asm et ts=4 sw=4:
       134D :
       134D :                            end
