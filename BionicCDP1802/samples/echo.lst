   0:                             CPU  1802
   0:                             INCLUDE              "cdp1802.inc"
   0:             ;;; -*- mode: asm; mode: flyspell-prog; -*-
   0:
   0:             ;;; CDP1802 register alias
   0: =$0         R0:             EQU  0
   0: =$1         R1:             EQU  1
   0: =$2         R2:             EQU  2
   0: =$3         R3:             EQU  3
   0: =$4         R4:             EQU  4
   0: =$5         R5:             EQU  5
   0: =$6         R6:             EQU  6
   0: =$7         R7:             EQU  7
   0: =$8         R8:             EQU  8
   0: =$9         R9:             EQU  9
   0: =$A         R10:            EQU  10
   0: =$B         R11:            EQU  11
   0: =$C         R12:            EQU  12
   0: =$D         R13:            EQU  13
   0: =$E         R14:            EQU  14
   0: =$F         R15:            EQU  15
   0:
   0:             ;;; Transfer locations
   0: =$0         ORG_RESET:      EQU  0000H           ; Reset transfer location
   0:
   0:             ;;; MC6850 Asynchronous Communication Interface Adapter
   0: =$DF00      ACIA:           EQU  0DF00H
   0:                             INCLUDE              "mc6850.inc"
   0:             ;;; -*- mode: asm; mode: flyspell-prog; -*-
   0:
   0:             ;;; MC6850
   0:             ;;; Asynchronous Communication Interface Adapter
   0:
   0:             ;;; Control register
   0: =$DF00      ACIA_control:   EQU  ACIA+0
   0:             ;; Counter Divider Select Bits
   0: =$3         CDS_gm:         EQU  11b             ; Group mask
   0: =$0         CDS_DIV1_gc:    EQU  00000000B       ; /1
   0: =$1         CDS_DIV16_gc:   EQU  00000001B       ; /16
   0: =$2         CDS_DIV64_gc:   EQU  00000010B       ; /64
   0: =$3         CDS_RESET_gc:   EQU  00000011B       ; Master Reset
   0:             ;; Word Select Bits
   0: =$1C        WSB_gm:         EQU  00011100B       ; Group mask
   0: =$0         WSB_7E2_gc:     EQU  00000000B       ; 7 Bits + Even Parity + 2 Stop Bits
   0: =$4         WSB_7O2_gc:     EQU  00000100B       ; 7 bits + Odd Parity  + 2 Stop Bits
   0: =$8         WSB_7E1_gc:     EQU  00001000B       ; 7 bits + Even Parity + 1 Stop Bits
   0: =$C         WSB_7O1_gc:     EQU  00001100B       ; 7 bits + Odd Parity  + 1 Stop Bits
   0: =$10        WSB_8N2_gc:     EQU  00010000B       ; 8 bits + No Parity   + 2 Stop Bits
   0: =$14        WSB_8N1_gc:     EQU  00010100B       ; 8 bits + No Parity   + 1 Stop Bits
   0: =$18        WSB_8E1_gc:     EQU  00011000B       ; 8 bits + Even Parity + 1 Stop Bits
   0: =$1C        WSB_8O1_gc:     EQU  00011100B       ; 8 bits + Odd Parity  + 1 Stop Bits
   0:             ;; Transmit Control Bits
   0: =$60        TCB_gm:         EQU  01100000B       ; Group mask
   0: =$0         TCB_DI_gc:      EQU  00000000B       ; RTS=Low,  Tx Interrupt Disabled
   0: =$20        TCB_EI_gc:      EQU  00100000B       ; RTS=Low,  Tx Interrupt Enabled
   0: =$40        TCB_RTS_gc:     EQU  01000000B       ; RTS=High, Tx Interrupt Disabled
   0: =$60        TCB_BREAK_gc:   EQU  01100000B       ; RTS=Low,  Tx Interrupt Disabled
   0:             ; Transmit Break Level
   0: =$80        RIEB_bm:        EQU  10000000B       ; Receive Interrupt Enable Bit mask
   0:
   0:             ;;; Status register
   0: =$DF00      ACIA_status:    EQU  ACIA+0
   0: =$1         RDRF_bm:        EQU  00000001B       ; Receive Data Register Full
   0: =$2         TDRE_bm:        EQU  00000010B       ; Transmit Data Register Empty
   0: =$4         DCDF_bm:        EQU  00000100B       ; Data Carrier Detect Flag
   0: =$8         CTSF_bm:        EQU  00001000B       ; Clear To Send Flag
   0: =$10        FERR_bm:        EQU  00010000B       ; Frame Error Flag
   0: =$20        OVRN_bm:        EQU  00100000B       ; Receiver Overrun Flag
   0: =$40        PERR_bm:        EQU  01000000B       ; Parity Error Flag
   0: =$80        IRQF_bm:        EQU  10000000B       ; Interrupt Request Flag
   0:
   0:             ;;; Data register
   0: =$DF01      ACIA_data:      EQU  ACIA+1          ; Data register
   0:
 100:                             ORG  0100H
 100:             main:
 100: F8 DF                       LDI  hi(ACIA)
 102: B8                          PHI  R8
 103: F8 00                       LDI  lo(ACIA)
 105: A8                          PLO  R8              ; R8=ACIA
 106: F8 03                       LDI  CDS_RESET_gc    ; Master reset
 108: 58                          STR  R8              ; ACIA_control
 109: F8 14                       LDI  WSB_8N1_gc      ; 8 bits + No Parity + 1 Stop Bits
 10B:             ; Transmit, Receive interrupts disabled
 10B: 58                          STR  R8              ; ACIA_control
 10C:
 10C:             receive_loop:
 10C: 08                          LDN  R8              ; ACIA_status
 10D: FA 01                       ANI  RDRF_bm
 10F: 32 0C                       BZ   receive_loop
 111:             receive_data:
 111: 18                          INC  R8              ; R8=ACIA_data
 112: 08                          LDN  R8              ; d=char
 113: 28                          DEC  R8              ; R8=ACIA_status
 114: A7                          PLO  R7              ; R7.0=char
 115:             transmit_loop:
 115: 08                          LDN  R8              ; ACIA_status
 116: FA 02                       ANI  TDRE_bm
 118: 32 15                       BZ   transmit_loop
 11A:             transmit_data:
 11A: 87                          GLO  R7
 11B: 18                          INC  R8              ; R8=ACIA_data
 11C: 58                          STR  R8              ; ACIA_data
 11D: 28                          DEC  R8              ; R8=ACIA_status
 11E: FB 0D                       XRI  0dh
 120: 3A 0C                       BNZ  receive_loop
 122: F8 0A                       LDI  0ah
 124: A7                          PLO  R7              ; R7.0=char
 125: 30 15                       BR   transmit_loop
 127:
   0:                             ORG  ORG_RESET
   0: 71                          DIS                  ; IE=0
   1: 00                          DB   00h             ; X:P=0:0
   2: F8 01                       LDI  hi(main)
   4: B3                          PHI  R3
   5: F8 00                       LDI  lo(main)
   7: A3                          PLO  R3
   8: D3                          SEP  R3              ; jump to main with R3 as PC
